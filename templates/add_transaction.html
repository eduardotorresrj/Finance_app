{% extends 'base.html' %}
{% block title %}Adicionar Receita/Despesa - Finance App{% endblock %}
{% block content %}
<div class="row">
  <div class="col-md-8">
    <div class="card">
      <div class="card-body">
        <h2 class="card-title mb-4">
          <i class="fas fa-plus-circle me-2"></i>
          Adicionar Receita/Despesa
        </h2>
        
        <form method="post" enctype="multipart/form-data" id="transaction-form">
          <div class="mb-3">
            <label for="type" class="form-label">Tipo</label>
            <select class="form-select" id="type" name="type" required>
              <option value="income">Receita</option>
              <option value="expense">Despesa</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="category" class="form-label">Categoria</label>
            <input type="text" class="form-control" id="category" name="category" required>
          </div>
          <div class="mb-3">
            <label for="amount" class="form-label">Valor</label>
            <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Descri칞칚o</label>
            <input type="text" class="form-control" id="description" name="description">
          </div>
          <div class="mb-3">
            <label for="date" class="form-label">Data</label>
            <input type="date" class="form-control" id="date" name="date" value="{{ now|default('') }}" required>
          </div>
          <div class="mb-3">
            <label for="image" class="form-label">
              <i class="fas fa-camera me-1"></i>
              Foto da Conta/Nota (Opcional)
            </label>
            <input type="file" class="form-control" id="image" name="image" accept="image/*" capture="environment">
            <div class="form-text">Tire uma foto da conta ou nota para reconhecimento autom치tico</div>
            <div class="mt-2">
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="openCamera()">
                <i class="fas fa-camera me-1"></i>
                Abrir C칙mera
              </button>
            </div>
          </div>
          <button type="submit" class="btn btn-success w-100">
            <i class="fas fa-save me-2"></i>
            Adicionar
          </button>
        </form>
        
        <div class="mt-3 text-center">
          <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Voltar ao Dashboard
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Painel de Reconhecimento -->
  <div class="col-md-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">
          <i class="fas fa-magic me-2"></i>
          Reconhecimento Inteligente
        </h5>
        
        <div class="text-center mb-3">
          <button type="button" class="btn btn-primary" onclick="captureImage()">
            <i class="fas fa-camera me-2"></i>
            Tirar Foto
          </button>
        </div>
        
        <div id="recognition-result" style="display: none;">
          <div class="alert alert-info">
            <h6>游늶 Resultado do Reconhecimento:</h6>
            <div id="detected-info">
              <p><strong>Tipo:</strong> <span id="detected-type">-</span></p>
              <p><strong>Categoria:</strong> <span id="detected-category">-</span></p>
              <p><strong>Confian칞a:</strong> <span id="detected-confidence">-</span></p>
            </div>
            <button type="button" class="btn btn-sm btn-success" onclick="applyRecognition()">
              <i class="fas fa-check me-1"></i>
              Aplicar
            </button>
          </div>
        </div>
        
        <div class="mt-3">
          <h6>游눠 Dicas:</h6>
          <ul class="small">
            <li>Posicione a conta/nota bem iluminada</li>
            <li>Mantenha a c칙mera est치vel</li>
            <li>O app reconhecer치 automaticamente o tipo</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function captureImage() {
  const input = document.getElementById('image');
  input.click();
}

function openCamera() {
  // Verificar se o navegador suporta getUserMedia
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    // Tentar abrir a c칙mera
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(function(stream) {
        // Se conseguir acessar a c칙mera, abrir o input de arquivo
        const input = document.getElementById('image');
        input.click();
      })
      .catch(function(err) {
        // Se n칚o conseguir, mostrar mensagem
        alert('N칚o foi poss칤vel acessar a c칙mera. Verifique as permiss칫es.');
        console.log('Erro ao acessar c칙mera:', err);
      });
  } else {
    // Fallback para navegadores que n칚o suportam
    const input = document.getElementById('image');
    input.click();
  }
}

document.getElementById('image').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    // Mostrar loading
    showLoading();
    
    // Simular processamento de imagem
    setTimeout(() => {
      processImageRecognition(file);
    }, 2000);
  }
});

function showLoading() {
  document.getElementById('recognition-result').style.display = 'block';
  document.getElementById('detected-info').innerHTML = `
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Processando...</span>
      </div>
      <p class="mt-2">Processando imagem...</p>
    </div>
  `;
}

function processImageRecognition(file) {
  // Tentar usar a API do backend primeiro
  const formData = new FormData();
  formData.append('image', file);
  
  fetch('/upload_image', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Usar dados do backend
      applyRecognitionAutomatically(data.type, data.category, data.amount, data.confidence);
      showRecognitionResult(data.type, data.category, data.confidence);
    } else {
      // Fallback para reconhecimento local
      processImageLocally(file);
    }
  })
  .catch(error => {
    console.log('Erro na API, usando reconhecimento local:', error);
    processImageLocally(file);
  });
}

function processImageLocally(file) {
  // Reconhecimento local melhorado baseado no nome do arquivo ou conte칰do
  const fileName = file.name.toLowerCase();
  const fileSize = file.size;
  
  let detectedType = 'expense';
  let detectedCategory = 'Outros';
  let detectedAmount = '';
  let confidence = 85;
  
  // Dicion치rio de reconhecimento local
  const localRecognition = {
    // Contas de Casa
    'luz': { category: 'Energia', amount: '150.00' },
    'energia': { category: 'Energia', amount: '150.00' },
    'eletricidade': { category: 'Energia', amount: '150.00' },
    'light': { category: 'Energia', amount: '150.00' },
    
    'agua': { category: '츼gua', amount: '80.00' },
    'water': { category: '츼gua', amount: '80.00' },
    'saneamento': { category: '츼gua', amount: '80.00' },
    
    'gas': { category: 'G치s', amount: '120.00' },
    'glp': { category: 'G치s', amount: '120.00' },
    
    'internet': { category: 'Internet', amount: '89.90' },
    'wifi': { category: 'Internet', amount: '89.90' },
    'banda larga': { category: 'Internet', amount: '89.90' },
    'telecom': { category: 'Internet', amount: '89.90' },
    
    'telefone': { category: 'Telefone', amount: '45.00' },
    'phone': { category: 'Telefone', amount: '45.00' },
    'celular': { category: 'Telefone', amount: '45.00' },
    'mobile': { category: 'Telefone', amount: '45.00' },
    
    'aluguel': { category: 'Moradia', amount: '800.00' },
    'rent': { category: 'Moradia', amount: '800.00' },
    'condominio': { category: 'Moradia', amount: '300.00' },
    
    // Taxas e Impostos
    'taxa': { category: 'Taxas', amount: '50.00' },
    'tax': { category: 'Taxas', amount: '50.00' },
    'imposto': { category: 'Impostos', amount: '100.00' },
    'iptu': { category: 'Impostos', amount: '200.00' },
    'ipva': { category: 'Impostos', amount: '500.00' },
    'irpf': { category: 'Impostos', amount: '300.00' },
    
    // Corpo de Bombeiros
    'bombeiros': { category: 'Taxas', amount: '30.00' },
    'incendio': { category: 'Taxas', amount: '30.00' },
    'fire': { category: 'Taxas', amount: '30.00' },
    'cbmerj': { category: 'Taxas', amount: '30.00' },
    'corpo de bombeiros': { category: 'Taxas', amount: '30.00' },
    
    // Transporte
    'transporte': { category: 'Transporte', amount: '200.00' },
    'uber': { category: 'Transporte', amount: '50.00' },
    'combustivel': { category: 'Transporte', amount: '300.00' },
    'gasolina': { category: 'Transporte', amount: '300.00' },
    'etanol': { category: 'Transporte', amount: '250.00' },
    
    // Sa칰de
    'saude': { category: 'Sa칰de', amount: '200.00' },
    'medico': { category: 'Sa칰de', amount: '150.00' },
    'farmacia': { category: 'Sa칰de', amount: '80.00' },
    'consulta': { category: 'Sa칰de', amount: '200.00' },
    
    // Educa칞칚o
    'escola': { category: 'Educa칞칚o', amount: '500.00' },
    'faculdade': { category: 'Educa칞칚o', amount: '800.00' },
    'universidade': { category: 'Educa칞칚o', amount: '800.00' },
    'curso': { category: 'Educa칞칚o', amount: '200.00' },
    'livro': { category: 'Educa칞칚o', amount: '50.00' },
    
    // Lazer
    'lazer': { category: 'Lazer', amount: '100.00' },
    'cinema': { category: 'Lazer', amount: '30.00' },
    'restaurante': { category: 'Lazer', amount: '80.00' },
    'bar': { category: 'Lazer', amount: '60.00' },
    'shopping': { category: 'Lazer', amount: '150.00' },
    
    // Receitas
    'nota': { category: 'Sal치rio', amount: '2500.00', type: 'income' },
    'receita': { category: 'Sal치rio', amount: '2500.00', type: 'income' },
    'income': { category: 'Sal치rio', amount: '2500.00', type: 'income' },
    'salario': { category: 'Sal치rio', amount: '2500.00', type: 'income' },
    'pagamento': { category: 'Sal치rio', amount: '2500.00', type: 'income' },
    'bonus': { category: 'B칪nus', amount: '500.00', type: 'income' },
    'comissao': { category: 'Comiss칚o', amount: '300.00', type: 'income' },
    'freelance': { category: 'Freelance', amount: '400.00', type: 'income' },
    'extra': { category: 'Renda Extra', amount: '200.00', type: 'income' }
  };
  
  // Tentar reconhecimento baseado no nome do arquivo
  let bestMatch = null;
  let bestScore = 0;
  
  for (const [keyword, info] of Object.entries(localRecognition)) {
    if (fileName.includes(keyword)) {
      const score = keyword.length;
      if (score > bestScore) {
        bestScore = score;
        bestMatch = info;
      }
    }
  }
  
  if (bestMatch) {
    detectedCategory = bestMatch.category;
    detectedAmount = bestMatch.amount;
    if (bestMatch.type) {
      detectedType = bestMatch.type;
    }
    confidence = 90;
  } else {
    // Reconhecimento gen칠rico baseado no tamanho da imagem
    if (fileSize > 2000000) { // Imagem muito grande
      detectedCategory = 'Documento Oficial';
      detectedAmount = '100.00';
    } else if (fileSize > 1000000) { // Imagem grande
      detectedCategory = 'Taxas';
      detectedAmount = '50.00';
    } else {
      detectedCategory = 'Despesa Geral';
      detectedAmount = '100.00';
    }
    confidence = 75;
  }
  
  // Aplicar automaticamente os dados detectados
  applyRecognitionAutomatically(detectedType, detectedCategory, detectedAmount, confidence);
  
  // Mostrar resultado
  showRecognitionResult(detectedType, detectedCategory, confidence);
}

function applyRecognitionAutomatically(type, category, amount, confidence) {
  // Preencher automaticamente os campos
  document.getElementById('type').value = type;
  document.getElementById('category').value = category;
  document.getElementById('amount').value = amount;
  
  // Adicionar descri칞칚o autom치tica
  const description = `Conta de ${category} - Reconhecida automaticamente (${confidence}% de confian칞a)`;
  document.getElementById('description').value = description;
  
  // Definir data atual
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('date').value = today;
  
  // Mostrar mensagem de sucesso
  showSuccessMessage();
}

function showRecognitionResult(type, category, confidence) {
  document.getElementById('detected-type').textContent = type === 'income' ? 'Receita' : 'Despesa';
  document.getElementById('detected-category').textContent = category;
  document.getElementById('detected-confidence').textContent = confidence + '%';
}

function showSuccessMessage() {
  // Criar mensagem de sucesso
  const successDiv = document.createElement('div');
  successDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
  successDiv.innerHTML = `
    <i class="fas fa-check-circle me-2"></i>
    <strong>Reconhecimento autom치tico realizado!</strong> 
    Todos os campos foram preenchidos automaticamente.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  // Inserir antes do formul치rio
  const form = document.getElementById('transaction-form');
  form.parentNode.insertBefore(successDiv, form);
  
  // Remover mensagem ap칩s 5 segundos
  setTimeout(() => {
    if (successDiv.parentNode) {
      successDiv.remove();
    }
  }, 5000);
}

function applyRecognition() {
  // Esta fun칞칚o agora 칠 redundante, mas mantida para compatibilidade
  alert('Os dados j치 foram aplicados automaticamente!');
}
</script>
{% endblock %} 